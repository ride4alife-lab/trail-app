<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Trail App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<!-- Chart.js (may fail offline) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

#map {
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
}

#sidebar {
    position:absolute;
    top:10px;
    left:10px;
    background:white;
    padding:10px;
    border-radius:6px;
    box-shadow:0 0 8px rgba(0,0,0,0.25);
    z-index:2;
    max-height:70vh;
    overflow-y:auto;
    width:auto;
    max-width:80vw;
}

.trail-item {
    cursor:pointer;
    padding:3px 0;
}

#profileContainer {
    position:fixed;
    left:0;
    bottom:0;
    width:100%;
    height:180px;
    background:white;
    box-shadow:0 -2px 6px rgba(0,0,0,0.3);
    display:none;
    z-index:999;
}

#profileMessage {
    padding:20px;
    text-align:center;
    font-size:14px;
}
</style>
</head>
<body>

<div id="sidebar">
<b>Trails</b>
<div id="trailList"></div>
<hr>
<div>■ Easy</div>
<div>■ Intermediate</div>
<div>■ Advanced</div>
</div>

<div id="map"></div>

<div id="profileContainer">
<canvas id="profileChart"></canvas>
<div id="profileMessage" style="display:none;">
Elevation profile unavailable (offline)
</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibHVuZG9uIiwiYSI6ImNtbTB4eWd3YzAzcDgydnEyNGRwYWViN2YifQ.cdVVhtxFaLP6DWSYnGXn2g';

let currentPopup = null;
let profileChart = null;

const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/outdoors-v12',
    center:[-105.0633,39.9223],
    zoom:14
});

map.on('load', loadTrails);

function loadTrails(){

    fetch('map.geojson?v=2')
    .then(r=>r.json())
    .then(data=>{

        map.addSource('trails',{
            type:'geojson',
            data:data
        });

        map.addLayer({
            id:'trail-lines',
            type:'line',
            source:'trails',
            paint:{
                'line-width':4,
                'line-color':[
                    'match',
                    ['downcase',['get','traildifficulty']],
                    'easy','#2ecc71',
                    'intermediate','#0074D9',
                    'advanced','#000000',
                    '#ff0000'
                ]
            }
        });

        map.addLayer({
            id:'trail-highlight',
            type:'line',
            source:'trails',
            paint:{
                'line-width':8,
                'line-color':'#FFD700'
            },
            filter:['==','trailnumber','']
        });

        buildSidebar(data);

        map.on('click','trail-lines', e=>{
            selectTrail(e.features[0]);
        });
    });
}

function buildSidebar(data){
    const list = document.getElementById('trailList');
    list.innerHTML = '';

    data.features.forEach(f=>{
        const item = document.createElement('div');
        item.className = 'trail-item';
        item.textContent = f.properties.trailnumber + ' – ' + f.properties.trailname;
        item.onclick = ()=>selectTrail(f);
        list.appendChild(item);
    });
}

function selectTrail(feature){

    if(currentPopup) currentPopup.remove();

    map.setFilter('trail-highlight',
        ['==',
            ['to-string',['get','trailnumber']],
            String(feature.properties.trailnumber)
        ]
    );

    const coords = feature.geometry.coordinates;

    const bounds = coords.reduce((b,c)=>b.extend(c),
        new mapboxgl.LngLatBounds(coords[0],coords[0])
    );
    map.fitBounds(bounds,{padding:40});

    const mid = coords[Math.floor(coords.length/2)];

    currentPopup = new mapboxgl.Popup()
        .setLngLat(mid)
        .setHTML('<b>'+feature.properties.trailname+'</b>')
        .addTo(map);

    showElevationProfile(coords);
}

function showElevationProfile(coords){

    document.getElementById('profileContainer').style.display = 'block';
    map.resize();

    // If Chart.js failed to load
    if(typeof Chart === 'undefined'){
        document.getElementById('profileChart').style.display = 'none';
        document.getElementById('profileMessage').style.display = 'block';
        return;
    }

    document.getElementById('profileChart').style.display = 'block';
    document.getElementById('profileMessage').style.display = 'none';

    let dist = 0;
    const distances = [];
    const elevations = [];

    function d(a,b){
        const R = 6371000;
        const toRad = x => x*Math.PI/180;
        const dLat = toRad(b[1]-a[1]);
        const dLon = toRad(b[0]-a[0]);
        const x = dLon * Math.cos(toRad((a[1]+b[1])/2));
        const y = dLat;
        return Math.sqrt(x*x + y*y) * R;
    }

    for(let i=0;i<coords.length;i++){
        if(coords[i].length >= 3){
            elevations.push(coords[i][2]);
        } else {
            elevations.push(0);
        }

        if(i>0) dist += d(coords[i-1],coords[i]);
        distances.push((dist/1000).toFixed(2));
    }

    const ctx = document.getElementById('profileChart');

    if(profileChart) profileChart.destroy();

    profileChart = new Chart(ctx,{
        type:'line',
        data:{
            labels:distances,
            datasets:[{
                data:elevations,
                borderColor:'#0074D9',
                fill:true,
                tension:0.1
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{display:false}}
        }
    });
}
</script>

</body>
</html>