<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Trail App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

#map {
    position:absolute;
    top:0;
    bottom:0;
    width:100%;
}

/* Sidebar – auto width */
#sidebar {
    position:absolute;
    top:10px;
    left:10px;
    background:white;
    padding:10px;
    border-radius:6px;
    box-shadow:0 0 8px rgba(0,0,0,0.25);
    z-index:2;
    max-height:75vh;
    overflow-y:auto;
    width:auto;
    max-width:80vw;
}

/* Mobile collapse */
@media (max-width:600px){
    #sidebar.collapsed {
        display:none;
    }
}

.trail-item {
    cursor:pointer;
    padding:3px 0;
}

.controls button {
    display:block;
    width:100%;
    margin-top:4px;
}
</style>
</head>
<body>

<div id="sidebar">
<b>Trails</b>
<div id="trailList"></div>

<hr>

<div>■ Easy</div>
<div>■ Intermediate</div>
<div>■ Advanced</div>

<hr>

<div class="controls">
<button id="centerBtn">Center on Me</button>
<button id="followBtn">Follow: OFF</button>
<button id="styleBtn">Terrain</button>
</div>
</div>

<div id="map"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibHVuZG9uIiwiYSI6ImNtbTB4eWd3YzAzcDgydnEyNGRwYWViN2YifQ.cdVVhtxFaLP6DWSYnGXn2g';

let followMode = false;
let userMarker = null;
let watchId = null;
let currentPopup = null;
let currentStyle = 'streets';

const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/streets-v12',
    center:[-105.063,39.922],
    zoom:15
});

map.on('load', loadTrails);

/* ---------- Style Toggle ---------- */
document.getElementById('styleBtn').onclick = function(){
    currentStyle = (currentStyle === 'streets') ? 'outdoors' : 'streets';
    map.setStyle('mapbox://styles/mapbox/' + currentStyle + '-v12');
    map.once('style.load', loadTrails);
};

/* ---------- Location ---------- */
function startLocation(centerOnce){
    if(!navigator.geolocation) return;

    if(watchId) navigator.geolocation.clearWatch(watchId);

    watchId = navigator.geolocation.watchPosition(pos => {
        const lng = pos.coords.longitude;
        const lat = pos.coords.latitude;

        if(!userMarker){
            userMarker = new mapboxgl.Marker({color:'#0074D9'})
                .setLngLat([lng,lat])
                .addTo(map);
        } else {
            userMarker.setLngLat([lng,lat]);
        }

        if(centerOnce || followMode){
            map.easeTo({center:[lng,lat], duration:500});
        }

    }, err => console.log(err), {
        enableHighAccuracy:true,
        maximumAge:5000
    });
}

document.getElementById('centerBtn').onclick = () => startLocation(true);

document.getElementById('followBtn').onclick = function(){
    followMode = !followMode;
    this.textContent = 'Follow: ' + (followMode ? 'ON' : 'OFF');
    if(followMode) startLocation(false);
};

/* ---------- Trails ---------- */
function loadTrails(){

    fetch('map.geojson?v=1')
    .then(r => r.json())
    .then(data => {

        if(map.getSource('trails')){
            map.removeLayer('trail-lines');
            map.removeLayer('trail-highlight');
            map.removeSource('trails');
        }

        map.addSource('trails',{
            type:'geojson',
            data:data
        });

        // Difficulty colors
        map.addLayer({
            id:'trail-lines',
            type:'line',
            source:'trails',
            paint:{
                'line-width':4,
                'line-color':[
                    'match',
                    ['downcase',['get','traildifficulty']],
                    'easy','#2ecc71',
                    'intermediate','#0074D9',
                    'advanced','#000000',
                    '#ff0000'
                ]
            }
        });

        // Gold highlight
        map.addLayer({
            id:'trail-highlight',
            type:'line',
            source:'trails',
            paint:{
                'line-width':8,
                'line-color':'#FFD700'
            },
            filter:['==','trailnumber','']
        });

        buildSidebar(data);

        map.on('click','trail-lines', e=>{
            selectTrail(e.features[0]);
        });
    });
}

/* ---------- Sidebar ---------- */
function buildSidebar(data){
    const list = document.getElementById('trailList');
    list.innerHTML = '';

    data.features.forEach(f=>{
        const item = document.createElement('div');
        item.className = 'trail-item';
        item.textContent = f.properties.trailnumber + ' – ' + f.properties.trailname;
        item.onclick = () => selectTrail(f);
        list.appendChild(item);
    });
}

/* ---------- Select Trail ---------- */
function selectTrail(feature){

    if(currentPopup) currentPopup.remove();

    map.setFilter('trail-highlight',
        ['==',
            ['to-string',['get','trailnumber']],
            String(feature.properties.trailnumber)
        ]
    );

    const coords = feature.geometry.coordinates;

    const bounds = coords.reduce((b,c)=>b.extend(c),
        new mapboxgl.LngLatBounds(coords[0],coords[0])
    );

    map.fitBounds(bounds,{padding:40});

    const mid = coords[Math.floor(coords.length/2)];

    currentPopup = new mapboxgl.Popup()
        .setLngLat(mid)
        .setHTML('<b>'+feature.properties.trailname+'</b>')
        .addTo(map);

    // Collapse sidebar on phone
    if(window.innerWidth < 600){
        document.getElementById('sidebar').classList.add('collapsed');
    }
}
</script>

</body>
</html>