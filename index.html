<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Trail App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
body { margin: 0; padding: 0; font-family: Arial, sans-serif; }

#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}

/* Sidebar */
#sidebar {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 220px;
    max-height: 80%;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
    overflow-y: auto;
    z-index: 2;
}

/* Mobile adjustments */
@media (max-width: 600px) {
    #sidebar {
        width: 160px;
        font-size: 13px;
        padding: 8px;
    }
}

.trail-item {
    padding: 5px;
    margin-bottom: 4px;
    border-radius: 4px;
    cursor: pointer;
}

.trail-item:hover {
    background: #f0f0f0;
}

.legend {
    margin-top: 8px;
    font-size: 13px;
}

/* Center button */
#locateBtn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 3;
    background: #0074D9;
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    cursor: pointer;
}

/* Hide on desktop */
@media (min-width: 700px) {
    #locateBtn {
        display: none;
    }
}
</style>
</head>
<body>

<div id="sidebar">
<b>Trails</b>
<div id="trailList"></div>

<hr>

<b>Difficulty</b>
<div class="legend">
<div><span style="color:#2ecc71;">■■</span> Easy</div>
<div><span style="color:#0074D9;">■■</span> Intermediate</div>
<div><span style="color:#000000;">■■</span> Advanced</div>
</div>
</div>

<button id="locateBtn">Center on Me</button>

<div id="map"></div>

<script>

// Mapbox public token
mapboxgl.accessToken = 'pk.eyJ1IjoibHVuZG9uIiwiYSI6ImNtbTB4eWd3YzAzcDgydnEyNGRwYWViN2YifQ.cdVVhtxFaLP6DWSYnGXn2g';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-105.0633, 39.9223],
    zoom: 14
});

let trailsData = null;
let userMarker = null;
let trackingStarted = false;

// Load trails
map.on('load', function () {

    const dataUrl = 'map.geojson?v=1';

    map.addSource('trails', {
        type: 'geojson',
        data: dataUrl
    });

    map.addLayer({
        id: 'trail-lines',
        type: 'line',
        source: 'trails',
        paint: {
            'line-width': 5,
            'line-color': [
                'match',
                ['downcase', ['get', 'traildifficulty']],
                'easy', '#2ecc71',
                'intermediate', '#0074D9',
                'advanced', '#000000',
                '#ff0000'
            ]
        }
    });

    // Sidebar data
    fetch(dataUrl)
        .then(r => r.json())
        .then(data => {
            trailsData = data;
            buildSidebar(data);
        });

});

// Sidebar
function buildSidebar(data) {

    const list = document.getElementById('trailList');

    data.features.forEach(feature => {

        const p = feature.properties;

        const item = document.createElement('div');
        item.className = 'trail-item';
        item.textContent = p.trailnumber + ' – ' + p.trailname;

        item.onclick = function () {
            zoomToTrail(feature);
            showTrailPopup(feature);
        };

        list.appendChild(item);
    });
}

// Zoom helper
function zoomToTrail(feature) {

    const coords = feature.geometry.coordinates;

    const bounds = coords.reduce(function(bounds, coord) {
        return bounds.extend(coord);
    }, new mapboxgl.LngLatBounds(coords[0], coords[0]));

    map.fitBounds(bounds, { padding: 40 });
}

// Popup helper
function showTrailPopup(feature) {

    const coords = feature.geometry.coordinates;
    const mid = coords[Math.floor(coords.length / 2)];
    const p = feature.properties;

    new mapboxgl.Popup()
        .setLngLat(mid)
        .setHTML(
            '<b>' + p.trailname + ' (' + p.trailnumber + ')</b><br>' +
            'Difficulty: ' + p.traildifficulty + '<br>' +
            'Zone: ' + p.zonename
        )
        .addTo(map);
}

// Click trail line
map.on('click', 'trail-lines', function (e) {
    showTrailPopup(e.features[0]);
});

map.on('mouseenter', 'trail-lines', () => map.getCanvas().style.cursor = 'pointer');
map.on('mouseleave', 'trail-lines', () => map.getCanvas().style.cursor = '');


// GPS blue dot
function createUserDot() {
    const el = document.createElement('div');
    el.style.width = '16px';
    el.style.height = '16px';
    el.style.borderRadius = '50%';
    el.style.background = '#0074D9';
    el.style.border = '3px solid white';
    el.style.boxShadow = '0 0 6px rgba(0,0,0,0.5)';
    return el;
}

function updateUserLocation(lat, lon) {

    if (!userMarker) {
        userMarker = new mapboxgl.Marker(createUserDot())
            .setLngLat([lon, lat])
            .addTo(map);
    } else {
        userMarker.setLngLat([lon, lat]);
    }

    // Continuous recenter
    map.easeTo({
        center: [lon, lat],
        duration: 500
    });
}

// Center button
document.getElementById('locateBtn').onclick = function () {

    if (trackingStarted) return;

    trackingStarted = true;
    this.style.display = 'none';

    navigator.geolocation.watchPosition(
        pos => updateUserLocation(pos.coords.latitude, pos.coords.longitude),
        err => alert("Location error: " + err.message),
        { enableHighAccuracy: true }
    );
};

</script>

</body>
</html>