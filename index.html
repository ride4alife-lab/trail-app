<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Trail App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
body { margin: 0; padding: 0; font-family: Arial, sans-serif; }

#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}

#sidebar {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 220px;
    max-height: 90%;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
    overflow-y: auto;
    z-index: 2;
}

.trail-item {
    padding: 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    cursor: pointer;
}

.trail-item:hover {
    background: #f0f0f0;
}

.legend {
    margin-top: 8px;
    font-size: 14px;
}

#gpsBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 2;
    padding: 10px;
    background: white;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
}
</style>
</head>
<body>

<div id="sidebar">
<b>Trails</b>
<div id="trailList"></div>

<hr>

<b>Difficulty</b>
<div class="legend">
<div><span style="color:#2ecc71;">■■</span> Easy</div>
<div><span style="color:#0074D9;">■■</span> Intermediate</div>
<div><span style="color:#000000;">■■</span> Advanced</div>
</div>
</div>

<button id="gpsBtn">Center on Me</button>

<div id="map"></div>

<script>

mapboxgl.accessToken = 'pk.eyJ1IjoibHVuZG9uIiwiYSI6ImNtbTB4eWd3YzAzcDgydnEyNGRwYWViN2YifQ.cdVVhtxFaLP6DWSYnGXn2g';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-105.0633, 39.9223],
    zoom: 14
});

let trailData = null;
let userMarker = null;

map.on('load', function () {

    const dataUrl = 'map.geojson?v=1';

    map.addSource('trails', {
        type: 'geojson',
        data: dataUrl
    });

    map.addLayer({
        id: 'trail-lines',
        type: 'line',
        source: 'trails',
        paint: {
            'line-width': 5,
            'line-color': [
                'match',
                ['downcase', ['get', 'traildifficulty']],
                'easy', '#2ecc71',
                'intermediate', '#0074D9',
                'advanced', '#000000',
                '#ff0000'
            ]
        }
    });

    map.addLayer({
        id: 'trail-highlight',
        type: 'line',
        source: 'trails',
        paint: {
            'line-width': 8,
            'line-color': '#FFD700'
        },
        filter: ['==', 'trailnumber', '']
    });

    fetch(dataUrl)
        .then(r => r.json())
        .then(data => {

            trailData = data;

            const list = document.getElementById('trailList');

            data.features.forEach(feature => {

                const props = feature.properties;
                const coords = feature.geometry.coordinates;

                const item = document.createElement('div');
                item.className = 'trail-item';
                item.textContent = props.trailnumber + ' – ' + props.trailname;

                item.onclick = function () {

                    map.setFilter('trail-highlight', ['==', 'trailnumber', String(props.trailnumber)]);

                    const bounds = coords.reduce(
                        (b, c) => b.extend(c),
                        new mapboxgl.LngLatBounds(coords[0], coords[0])
                    );

                    map.fitBounds(bounds, { padding: 40 });
                };

                list.appendChild(item);
            });

            // Fit map to all trails
            const bounds = new mapboxgl.LngLatBounds();
            data.features.forEach(f => {
                f.geometry.coordinates.forEach(c => bounds.extend(c));
            });
            map.fitBounds(bounds, { padding: 40 });

        });

});

document.getElementById('gpsBtn').onclick = function () {

    if (!navigator.geolocation) {
        alert('Geolocation not supported');
        return;
    }

    navigator.geolocation.getCurrentPosition(function(position) {

        const lng = position.coords.longitude;
        const lat = position.coords.latitude;

        map.flyTo({
            center: [lng, lat],
            zoom: 16
        });

        if (userMarker) userMarker.remove();

        userMarker = new mapboxgl.Marker({ color: 'blue' })
            .setLngLat([lng, lat])
            .addTo(map);

        if (trailData) {

            let nearest = null;
            let minDist = Infinity;

            trailData.features.forEach(feature => {
                feature.geometry.coordinates.forEach(coord => {

                    const d = distance(lat, lng, coord[1], coord[0]);

                    if (d < minDist) {
                        minDist = d;
                        nearest = feature.properties.trailnumber;
                    }
                });
            });

            if (nearest) {
                map.setFilter('trail-highlight', ['==', 'trailnumber', String(nearest)]);
            }
        }

    }, function() {
        alert('Location permission denied');
    });
};

function distance(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = Math.PI / 180;

    const dLat = (lat2 - lat1) * toRad;
    const dLon = (lon2 - lon1) * toRad;

    const a =
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * toRad) *
        Math.cos(lat2 * toRad) *
        Math.sin(dLon/2) * Math.sin(dLon/2);

    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

</script>

</body>
</html>