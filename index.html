<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Trail App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<style>
body { margin: 0; padding: 0; font-family: Arial, sans-serif; }

#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}

/* Sidebar */
#sidebar {
    position: absolute;
    top: 10px;
    left: 10px;
    width: 220px;
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
    z-index: 1;
}

/* Smaller sidebar on mobile */
@media (max-width: 600px) {
    #sidebar {
        width: 150px;
        font-size: 13px;
        opacity: 0.9;
    }
}

/* Center button */
#locateBtn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    z-index: 2;
    background: #0074D9;
    color: white;
    border: none;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    cursor: pointer;
}

/* Hide button on desktop */
@media (min-width: 700px) {
    #locateBtn {
        display: none;
    }
}
</style>
</head>
<body>

<div id="sidebar">
<b>Difficulty</b><br>
<span style="color:#2ecc71;">■■</span> Easy<br>
<span style="color:#0074D9;">■■</span> Intermediate<br>
<span style="color:#000000;">■■</span> Advanced
</div>

<button id="locateBtn">Center on Me</button>

<div id="map"></div>

<script>

// Mapbox public token
mapboxgl.accessToken = 'pk.eyJ1IjoibHVuZG9uIiwiYSI6ImNtbTB4eWd3YzAzcDgydnEyNGRwYWViN2YifQ.cdVVhtxFaLP6DWSYnGXn2g';

// Create map
const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-105.0633, 39.9223],
    zoom: 14
});


// ---------- Load Trails ----------
map.on('load', function () {

    map.addSource('trails', {
        type: 'geojson',
        data: 'map.geojson?v=1'
    });

    map.addLayer({
        id: 'trail-lines',
        type: 'line',
        source: 'trails',
        paint: {
            'line-width': 5,
            'line-color': [
                'match',
                ['downcase', ['get', 'traildifficulty']],
                'easy', '#2ecc71',
                'intermediate', '#0074D9',
                'advanced', '#000000',
                '#ff0000'
            ]
        }
    });

});


// ---------- GPS Tracking ----------

let userMarker = null;
let trackingStarted = false;

// Create blue dot
function createUserDot() {
    const el = document.createElement('div');
    el.style.width = '16px';
    el.style.height = '16px';
    el.style.borderRadius = '50%';
    el.style.background = '#0074D9';
    el.style.border = '3px solid white';
    el.style.boxShadow = '0 0 6px rgba(0,0,0,0.5)';
    return el;
}

// Update user position
function updateUserLocation(lat, lon) {

    if (!userMarker) {
        userMarker = new mapboxgl.Marker(createUserDot())
            .setLngLat([lon, lat])
            .addTo(map);
    } else {
        userMarker.setLngLat([lon, lat]);
    }

    // Follow user (navigation mode)
    map.easeTo({
        center: [lon, lat],
        duration: 500
    });
}


// Center on Me button
document.getElementById('locateBtn').onclick = function () {

    if (trackingStarted) return;

    if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
    }

    trackingStarted = true;
    this.style.display = 'none';

    navigator.geolocation.watchPosition(
        function(position) {
            updateUserLocation(
                position.coords.latitude,
                position.coords.longitude
            );
        },
        function(err) {
            alert("Location error: " + err.message);
        },
        {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000
        }
    );
};


// ---------- Offline Support ----------
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker failed:', err));
}

</script>

</body>
</html>