<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Trail App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<!-- Local Chart.js for offline -->
<script src="chart.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

#map {
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
}

/* Sidebar */
#sidebar {
    position:absolute;
    top:10px;
    left:10px;
    background:white;
    padding:10px;
    border-radius:6px;
    box-shadow:0 0 8px rgba(0,0,0,0.25);
    z-index:2;
    max-height:70vh;
    overflow-y:auto;
    width:auto;
    max-width:80vw;
}

.trail-item {
    cursor:pointer;
    padding:3px 0;
}

/* Legend color squares */
.legend-row {
    display:flex;
    align-items:center;
    gap:6px;
}

.legend-box {
    width:14px;
    height:14px;
}

/* Elevation panel */
#profileContainer {
    position:fixed;
    left:0;
    bottom:0;
    width:100%;
    height:180px;
    background:white;
    box-shadow:0 -2px 6px rgba(0,0,0,0.3);
    display:none;
    z-index:999;
}
</style>
</head>
<body>

<div id="sidebar">
<b>Trails</b>
<div id="trailList"></div>

<hr>

<b>Difficulty</b>
<div class="legend-row">
<div class="legend-box" style="background:#2ecc71;"></div> Easy
</div>
<div class="legend-row">
<div class="legend-box" style="background:#0074D9;"></div> Intermediate
</div>
<div class="legend-row">
<div class="legend-box" style="background:#000000;"></div> Advanced
</div>
</div>

<div id="map"></div>

<div id="profileContainer">
<canvas id="profileChart"></canvas>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibHVuZG9uIiwiYSI6ImNtbTB4eWd3YzAzcDgydnEyNGRwYWViN2YifQ.cdVVhtxFaLP6DWSYnGXn2g';

let currentPopup = null;
let profileChart = null;
let trailData = null;

const map = new mapboxgl.Map({
    container:'map',
    style:'mapbox://styles/mapbox/outdoors-v12',
    center:[-105.0633,39.9223],
    zoom:14
});

map.on('load', loadTrails);

/* ---------- Load Trails ---------- */
function loadTrails(){

    fetch('map.geojson?v=4')
    .then(r=>r.json())
    .then(data=>{

        trailData = data;

        map.addSource('trails',{
            type:'geojson',
            data:data
        });

        map.addLayer({
            id:'trail-lines',
            type:'line',
            source:'trails',
            paint:{
                'line-width':4,
                'line-color':[
                    'match',
                    ['downcase',['get','traildifficulty']],
                    'easy','#2ecc71',
                    'intermediate','#0074D9',
                    'advanced','#000000',
                    '#ff0000'
                ]
            }
        });

        map.addLayer({
            id:'trail-highlight',
            type:'line',
            source:'trails',
            paint:{
                'line-width':8,
                'line-color':'#FFD700'
            },
            filter:['==','trailnumber','']
        });

        buildSidebar(data);

        /* Map click now uses SAME function */
        map.on('click','trail-lines', e=>{
            selectTrail(e.features[0]);
        });

        map.on('mouseenter','trail-lines',()=>map.getCanvas().style.cursor='pointer');
        map.on('mouseleave','trail-lines',()=>map.getCanvas().style.cursor='');
    });
}

/* ---------- Sidebar ---------- */
function buildSidebar(data){
    const list = document.getElementById('trailList');
    list.innerHTML = '';

    data.features.forEach(f=>{
        const item = document.createElement('div');
        item.className = 'trail-item';
        item.textContent = f.properties.trailnumber + ' â€“ ' + f.properties.trailname;
        item.onclick = ()=>selectTrail(f);
        list.appendChild(item);
    });
}

/* ---------- Select Trail (single source of truth) ---------- */
function selectTrail(feature){

    const props = feature.properties;

    /* Remove previous popup */
    if(currentPopup) currentPopup.remove();

    /* Highlight */
    map.setFilter('trail-highlight',
        ['==',
            ['to-string',['get','trailnumber']],
            String(props.trailnumber)
        ]
    );

    const coords = feature.geometry.coordinates;

    /* Zoom */
    const bounds = coords.reduce((b,c)=>b.extend(c),
        new mapboxgl.LngLatBounds(coords[0],coords[0])
    );
    map.fitBounds(bounds,{padding:40});

    /* Popup WITH number */
    const mid = coords[Math.floor(coords.length/2)];

    currentPopup = new mapboxgl.Popup()
        .setLngLat(mid)
        .setHTML(
            '<b>' + props.trailname + ' (' + props.trailnumber + ')</b><br>' +
            'Difficulty: ' + props.traildifficulty
        )
        .addTo(map);

    showElevationProfile(coords);
}

/* ---------- Elevation Profile ---------- */
function showElevationProfile(coords){

    if(typeof Chart === 'undefined') return;

    let dist = 0;
    const distances = [];
    const elevations = [];

    function d(a,b){
        const R = 6371000;
        const toRad = x => x*Math.PI/180;
        const dLat = toRad(b[1]-a[1]);
        const dLon = toRad(b[0]-a[0]);
        const x = dLon * Math.cos(toRad((a[1]+b[1])/2));
        const y = dLat;
        return Math.sqrt(x*x + y*y) * R;
    }

    for(let i=0;i<coords.length;i++){
        elevations.push(coords[i][2] || 0);

        if(i>0) dist += d(coords[i-1],coords[i]);
        distances.push((dist/1000).toFixed(2));
    }

    document.getElementById('profileContainer').style.display = 'block';
    map.resize();

    const ctx = document.getElementById('profileChart');

    if(profileChart) profileChart.destroy();

    profileChart = new Chart(ctx,{
        type:'line',
        data:{
            labels:distances,
            datasets:[{
                data:elevations,
                borderColor:'#0074D9',
                fill:true,
                tension:0.1
            }]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{legend:{display:false}}
        }
    });
}
</script>

</body>
</html>